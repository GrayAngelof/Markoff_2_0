# Система управления недвижимостью и мониторинга пожарной сигнализации
Общая Архитектура Системы
Система представляет собой локальную инфраструктуру для управления недвижимостью и мониторинга пожарной сигнализации в нескольких корпусах. Все компоненты размещены внутри сети фирмы, с белым IP для внешнего доступа (например, к Telegram-боту через API-шлюз). 
Ключевые принципы: 
Безопасность и изоляция: База данных (PostgreSQL) доступна только через API-сервер. LLM-сервер используется исключительно для обработки естественного языка (парсинг запросов и формирование ответов), без прямого доступа к БД или выполнения SQL-запросов.
Компоненты:
База данных (PostgreSQL): Источник истины, хранит структурированные данные.
API-сервер: Центральный хаб для запросов к БД. Поддерживает аутентификацию (например, по токенам или ролям пользователей).
LLM-сервер: Локальный сервер обрабатывает только NLP-задачи.
Десктопное приложение: Клиентский интерфейс для администраторов/менеджеров.
Telegram-бот: Интерфейс для пользователей, поддерживает текст и голос (с интеграцией speech-to-text).
Масштабируемость: В будущем бот можно расширить на другие мессенджеры через унифицированный API-адаптер.
Локальность: Всё работает внутри сети; белый IP используется для безопасного туннелирования трафика к боту.

Система разделена на модули для управления помещениями/арендаторами и мониторинга пожарной сигнализации. Данные обновляются в ручном режиме пользователями. 
Модель Данных в Базе Данных
БД организована в реляционном стиле для эффективных запросов. Основные таблицы (концептуально):
Корпуса (Buildings): ID, название. 
Этажи (Floors): ID, корпус_ID, номер_этажа.
Помещения (Rooms): ID, этаж_ID, номер_помещения, площадь (кв. м), тип_использования (офис, склад, etc.), ставка_за_квм (зависит от типа), статус_занятости (занято/свободно), арендатор_ID (если занято).
Арендаторы (Tenants): ID, название (АЗ, БЕЗ, etc.), контактные_данные, список_помещений (связь many-to-many через промежуточную таблицу).
Пожарная сигнализация (FireAlarms): ID, помещение_ID (или этаж_ID для общих зон как коридор), номер_устройства, шина_подключения, статус (включено, отключено, сработало, в_ремонте), дата_последнего_изменения, причина_отключения (опционально), обслуживающая_компания (если в ремонте).
Логи событий (EventLogs): ID, датчик_ID, тип_события (отключение, сработка, ремонт), timestamp, детали.

Связь many-to-many между арендаторами и помещениями позволяет одной фирме занимать несколько пространств. Ставки за кв. м хранятся в помещениях, но могут рассчитываться динамически (например, общая площадь арендатора = сумма площадей его помещений, общая стоимость = сумма (площадь * ставка)).

Функционал Десктопного Приложения: Это standalone-приложение, с графическим UI для администраторов. Подключается к API-серверу по локальной сети. 
Основные экраны и логика: Навигация по корпусам/этажам:
Дерево-вид: Корпус → Этаж → Помещения. Клик на помещении показывает детали (площадь, тип, ставка, арендатор, статус пожарки).
Поиск: Фильтр по корпусу/этажу для списка всех арендаторов на этаже (сортировка по имени/площади).
Вывод: Таблица с колонками (Арендатор, Помещение, Площадь, Тип, Ставка). Подсчёт итогов (занятая/свободная площадь на этаже).

Управление арендаторами:
Список всех арендаторов с поиском по имени.
Для выбранного: Список занимаемых помещений (группировка по корпусу/этажу), общая площадь, общая стоимость (расчёт на основе ставок).
Фильтр свободных помещений: Таблица с сортировкой по корпусу/этажу/площади/типу.

Мониторинг пожарной сигнализации:
Дашборд: Общая статистика (кол-во отключенных/сработавших датчиков по корпусам/этажам).
По датчику: Поиск по ID/месту, показывает статус, историю событий, шину подключения.
По помещению: Список датчиков в помещении, их статусы.
Статистика отключений: Графики/таблицы (по датчику/помещению/времени, с фильтрами по дате).
Уведомления: Реал-тайм обновления (push от API при изменении статуса).

Администрирование:
Добавление/редактирование данных (корпуса, помещения, арендаторов, датчики).
Экспорт отчётов (CSV/PDF: площади, аренда, пожарка).
Роли пользователей: Админ (полный доступ), Менеджер (только просмотр).

Логика: 
Приложение отправляет HTTP-запросы к API (GET/POST для чтения/обновления). Нет прямого доступа к БД.
Функционал Telegram-Бота:
Бот — это интерфейс для мобильных/голосовых запросов, интегрированный с Telegram API. Поддерживает текст и голос (голос преобразуется в текст с помощью встроенного speech-to-text, например, на базе Whisper локально). Бот не подключается напрямую к БД или API; все запросы проходят через LLM для парсинга.
Логика обработки запроса:
Пользователь отправляет сообщение (текст/голос). Если голос — конверсия в текст на сервере бота.
Бот передаёт текст в LLM-сервер с промптом: например: "Парси запрос на естественном языке в структурированный формат: тип_запроса (арендатор_поиск, площадь_расчёт, датчик_статус, etc.), параметры (имя_арендатора, корпус, этаж, etc.). Не генерируй SQL или данные."
LLM возвращает JSON-подобный объект (например, {"type": "tenant_location", "tenant": "АЗ"}).
Бот отправляет этот структурированный запрос в API-сервер (с аутентификацией пользователя по Telegram ID).
API-сервер выполняет запрос к БД (например, SELECT для локаций арендатора), возвращает сырые данные (JSON: список помещений, площади, статусы).
Бот передаёт сырые данные обратно в LLM с промптом: например:  "Сформируй естественный, аккуратный ответ на основе этих данных. Не добавляй вымышленную информацию."
LLM генерирует ответ (например, "Арендатор АЗ занимает офис в корпусе А, этаж 1, помещение 101 (50 кв.м) и склад в корпусе Б, этаж 2, помещение 203 (100 кв.м).").
Бот отправляет ответ пользователю (текст, возможно с markdown для таблиц).

Поддерживаемые запросы (примеры):
По арендаторам/помещениям: 
"Где находится арендатор АЗ?": Возвращает список помещений (корпус, этаж, номер, тип).
"Общая площадь у арендатора БЕЗ?": Расчёт суммы площадей, возможно с разбивкой по типам/корпусам.
"Свободные помещения в корпусе В?": Список с деталями (этаж, площадь, тип).

По пожарке:
"Как подключен датчик в коридоре 4 этажа корпуса Б?": Номер устройства, шина, текущий статус.
"Статистика отключений по помещению 101 в корпусе А?": Кол-во отключений, даты, причины.
"Где сейчас сработали датчики?": Список активных сработок по корпусам/этажам.

Комбинированные: "Площадь офиса арендатора АЗ и статус датчика там?" — LLM парсит в два подзапроса, API агрегирует, LLM объединяет в единый ответ.

Дополнительные фичи бота:
Аутентификация: При старте — ввод кода/токена для доступа (роли: пользователь видит только свои данные, админ — все).
Обработка ошибок: Если LLM не распарсил — запрос уточнения ("Уточните запрос").
Мульти-мессенджер: В будущем — абстрактный слой, где Telegram-адаптер заменяется на другие.
Голос: Автоматическая транскрипция; если шумно — запрос на текст.

Интеграция и Потоки Данных
Обновление данных: Десктопное приложение или внешние системы (IoT для пожарки) обновляют БД через API. Бот/приложение запрашивают актуальные данные.
Безопасность: API использует JWT-токены; LLM изолирован (только NLP, без сетевого доступа к БД).
Производительность: Для реал-тайм (пожарка) — WebSocket от API к десктопу/боту.
Расширение: Добавление новых корпусов/типов — через БД-схему; LLM обучается на примерах запросов для лучшего парсинга.

Эта концепция обеспечивает удобство, безопасность и масштабируемость без прямого доступа к чувствительным данным.
