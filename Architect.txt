# Переработанная архитектура системы с интеграцией LLM-ассистента

## **1. СИСТЕМНАЯ ФИЛОСОФИЯ: РАЗДЕЛЕНИЕ ОТВЕТСТВЕННОСТИ**
┌──────────────────────────────────────────────────────────────────────┐
│                   КОНЦЕПТУАЛЬНАЯ АРХИТЕКТУРА                         │
│                                                                      │
│  ┌─────────────────┐      ┌─────────────────┐      ┌──────────────┐  │
│  │   ФИЗИЧЕСКИЙ    │      │   БИЗНЕС-       │      │   ОПЕРАЦИИ   │  │
│  │     МИР         │      │   ЛОГИКА        │      │   И МОНИ-    │  │
│  │                 │◄─────┤                 │◄─────┤   ТОРИНГ     │  │
│  │ • Здания        │      │ • Арендаторы    │      │ • Датчики    │  │
│  │ • Этажи         │      │ • Договоры      │      │ • События    │  │
│  │ • Помещения     │      │ • Ставки        │      │ • Шины       │  │
│  │ • Зоны          │      │ • Платежи       │      │ • Уведомления│  │
│  └────────┬────────┘      └────────┬────────┘      └────────┬─────┘  │
│           │                        │                        │        │
│           └────────────┬───────────┼────────────────────────┘        │
│                        ▼           ▼                                 │
│               ┌──────────────────────────────────────┐               │
│               │       СЛОЙ РАЗМЕЩЕНИЙ                │               │
│               │    (связь физического и бизнеса)     │               │
│               │  • room_id → tenant_id               │               │
│               │  • period, rate, usage_type          │               │
│               └──────────────────────────────────────┘               │
│                        │                                             │
│                        ▼                                             │
│               ┌──────────────────────────────────────┐               │
│               │     ИНТЕЛЛЕКТУАЛЬНЫЙ ИНТЕРФЕЙС       │               │
│               │         (LLM-ассистент)              │               │
│               │  • Парсинг естественного языка       │←──────────────┘
│               │  • Генерация человекопонятных ответов│               │
│               └──────────────────────────────────────┘               │
└──────────────────────────────────────────────────────────────────────┘
**Ключевой принцип:** LLM-сервер работает исключительно как **интеллектуальный переводчик** — он не имеет прямого доступа к БД и не выполняет SQL-запросы. Все операции с данными проходят через API-сервер.

## **2. СЕТЕВАЯ АРХИТЕКТУРА С ИЗОЛЯЦИЕЙ КОМПОНЕНТОВ**
┌───────────────────────────────────────────────────────────────────────────────┐
│                ЛОКАЛЬНАЯ СЕТЬ ПРЕДПРИЯТИЯ                                     │
│  (VPN для удалённого доступа, белый IP только для Telegram-бота)              │
│                                                                               │
│  ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────────┐  │
│  │   СЕТЬ БД         │    │  СЕРВИСНАЯ        │    │   КЛИЕНТСКАЯ СЕТЬ     │  │
│  │  (изолированная)  │    │    СЕТЬ           │    │                       │  │
│  │                   │    │                   │    │  ┌────────────────┐   │  │
│  │  [PostgreSQL]     │    │  ┌────────┐       │    │  │   Десктопное   │   │  │
│  │      ↑            │    │  │  API   │◄──────┼────┼──│   приложение   │   │  │
│  │      │            │    │  │ сервер │       │    │  │   (Electron/   │   │  │
│  │  ┌───┴───┐        │    │  └───┬────┘       │    │  │    React)      │   │  │
│  │  │ Фаер- │        │    │      │            │    │  └────────────────┘   │  │
│  │  │ волл  │        │    │  ┌───▼────┐       │    │         ↑             │  │
│  │  └───┬───┘        │    │  │ LLM-   │       │    │   Пользователи        │  │
│  │      │            │    │  │ сервер │       │    │   в офисе             │  │
│  └──────┼────────────┘    │  └───┬────┘       │    └───────────────────────┘  │
│         │                 │      │            │                               │
│         └─────────────────┼──────┼────────────┘                               │
│                           │  ┌───▼─────┐                                      │
│                           │  │ Бот-    │                                      │
│                           │  │ сервис  │                                      │
│                           │  │ (адаптер│                                      │
│                           │  │ мессен- │                                      │
│                           │  │ джеров) │                                      │
│                           │  └─────────┘                                      │
│                           └────────────┬──────────────────────────────────────┘
│                                        │                                      │
│                            ┌───────────▼─────────────┐                        │
│                            │      DMZ / ПЕРИМЕТР     │                        │
│                            │                         │                        │
│                            │  ┌─────────────────┐    │                        │
│                            │  │   API Gateway   │◄───┼── Белый IP             │
│                            │  │                 │    │   (для Telegram)       │
│                            │  └─────────────────┘    │                        │
│                            │          │              │                        │
│                            │  ┌───────▼───────┐      │                        │
│                            │  │   VPN Server  │◄─────┼── Удалённые админы     │
│                            │  │               │      │                        │
│                            │  └───────────────┘      │                        │
│                            └─────────────────────────┘                        │
└───────────────────────────────────────────────────────────────────────────────┘

## **3. ЛОГИЧЕСКАЯ АРХИТЕКТУРА КОМПОНЕНТОВ**
### **3.1. ЦЕНТРАЛЬНОЕ ЯДРО СИСТЕМЫ**
                      ┌─────────────────┐
                      │   БАЗА ДАННЫХ   │
                      │   PostgreSQL    │
                      │                 │
                      │  Схемы:         │
                      │  • physical     │ ← Здания, этажи, помещения
                      │  • business     │ ← Арендаторы, договоры
                      │  • fire         │ ← Датчики, события, шины
                      │  • audit        │ ← Полный лог изменений
                      │  • cache        │ ← Сессии, кеш API-запросов
                      └─────────┬───────┘
                                │
                      ┌─────────▼───────┐
                      │   API СЕРВЕР    │
                      │ (единственный   │
                      │  исполнитель)   │
                      │                 │
                      │ • REST API      │
                      │ • WebSocket     │ ← Real-time уведомления
                      │ • Auth (JWT)    │ ← Аутентификация по ролям
                      │ • Бизнес-логика │ ← Валидация, расчёты
                      │ • Агрегаторы    │ ← "Общая площадь", "статистика"
                      └─────────┬───────┘
                 ┌──────────────┼─────────────┐
           ┌─────▼─────┐  ┌─────▼─────┐  ┌────▼──────┐
           │   LLM     │  │   БОТ     │  │  DESKTOP  │
           │  СЕРВЕР   │  │  СЕРВИС   │  │    APP    │
           │           │  │           │  │           │
           │ • Парсинг │  │ • Telegram│  │ • Electron│
           │   NLP     │  │ • WhatsApp│  │ • React   │
           │ • Генера- │  │ • Голос   │  │ • UI/UX   │
           │   ция     │  │ • Сессии  │  │ • Карты   │
           │   ответа  │  │           │  │ • Отчёты  │
           │ • STT/TTS │  │           │  │           │
           └───────────┘  └───────────┘  └───────────┘
## **4. ОБНОВЛЕННАЯ ОНТОЛОГИЯ СИСТЕМЫ**
### **4.1. ФИЗИЧЕСКИЙ МИР (physical_schema)**
КОМПЛЕКС (опциональная группировка)
    │
    ├── КОРПУС (id, name, floors_count, status)
    │       │
    │       ├── ЭТАЖ (id, building_id, number, type)
    │       │       │
    │       │       ├── ПОМЕЩЕНИЕ (id, floor_id, number, area, type)
    │       │       │       │      # type: office, warehouse, corridor, tech
    │       │       │       │
    │       │       │       └── ЗОНА (id, room_id, description)
    │       │       │                 # для детализации размещения датчиков
    │       │       │
    │       │       └── КОРИДОР (это помещение с type='corridor')
    │       │
    │       └── ТЕХНИЧЕСКИЙ ЭТАЖ (type='technical')

### **4.2. БИЗНЕС-ЛОГИКА (business_schema)**
АРЕНДАТОР (id, name, legal_info, contact)
    │
    ├── ДОГОВОР 1 (id, tenant_id, start_date, end_date)
    │       │
    │       └── РАЗМЕЩЕНИЕ 1 (id, contract_id, room_id, rate, status)
    │               │
    │               └──► ПОМЕЩЕНИЕ 101
    │
    ├── ДОГОВОР 2 (тот же арендатор, новый период)
    │       │
    │       └── РАЗМЕЩЕНИЕ 2 (параллельное размещение)
    │               │
    │               └──► ПОМЕЩЕНИЕ 203
    │
    └── РАСЧЁТЫ (связь с размещениями для финансовой отчётности)

### **4.3. МОНИТОРИНГ (fire_schema)**
СИСТЕМА ПОЖАРНОЙ СИГНАЛИЗАЦИИ
    │
    ├── ШИНА 1 (линия связи, id, description)
    │       │
    │       ├── ДАТЧИК ДЫМА #001 (id, bus_id, room_id, zone_id, status)
    │       │       │
    │       │       └──► СОБЫТИЯ (timestamp, old_status, new_status, comment)
    │       │
    │       ├── ДАТЧИК ТЕПЛА #002 (привязан к зоне внутри помещения)
    │       │
    │       └── ДАТЧИК РУЧНОЙ #003 (в коридоре - помещении type='corridor')
    │
    └── АВАРИЙНЫЕ СЦЕНАРИИ (правила автоматических уведомлений)

## **5. ПОТОКИ ДАННЫХ И ВЗАИМОДЕЙСТВИЕ**
### **5.1. ЗАПРОС ЧЕРЕЗ ТЕЛЕГРАМ-БОТА (голос/текст)**
┌────────────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ ПОЛЬЗОВАТЕЛЬ   │     │ Telegram  │     │ БОТ-      │     │ LLM-      │
│ "Где офис      │────►│   Бот     │────►│ СЕРВИС    │────►│ СЕРВЕР    │
│ арендатора     │     │           │     │           │     │           │
│ АЗ на 3 этаже?"│     │           │     │           │     │           │
└────────────────┘     └───────────┘     └───┬───────┘     └─────┬─────┘
        Голос → Текст (Whisper)              │                   │Парсинг NLP
                                             │                   │
                                      ┌──────▼──────┐  ┌─────────▼────┐
                                      │   API-      │  │ JSON-струк-  │
                                      │   СЕРВЕР    │  │ тура запроса:│
                                      │             │  │ {            │
                                      │ • Аутенти-  │  │   "type":    │
                                      │   фикация   │◄─┤   "find_     │
                                      │ • SQL-запрос│  │   tenant",   │
                                      │ • Бизнес-   │  │   "params": {│
                                      │   логика    │  │     "tenant":│
                                      └──────┬──────┘  │     "АЗ",    │
                                             │         │     "floor":3│
                                      ┌──────▼──────┐  │   }          │
                                      │   БАЗА      │  └──────────────┘
                                      │   ДАННЫХ    │
                                      │   (PostgreSQL)
                                      └──────┬──────┘
                                             │
                                      ┌──────▼──────┐     ┌──────────────┐
                                      │   LLM-      │     │ ПОЛЬЗОВАТЕЛЬ │
                                      │   СЕРВЕР    │────►│   (ответ)    │
                                      │             │     │              │
                                      │ • Генерация │     │ "Арендатор   │
                                      │   ответа    │     │ АЗ занимает  │
                                      │ • Формати-  │     │ офис 301     │
                                      │   рование   │     │ в корпусе А  │
                                      └─────────────┘     │ ..."         │
                                                          └──────────────┘

### **5.2. РАБОТА В ДЕСКТОПНОМ ПРИЛОЖЕНИИ**
┌──────────────┐     ┌───────────────┐      ┌──────────────┐
│  ОПЕРАТОР    │     │  DESKTOP APP  │      │  API-СЕРВЕР  │
│  (администра-│     │  (Electron/   │      │              │
│   тор)       │     │   React)      │      │              │
│              │     │               │      │              │
│ • Клик на    │────►│ • Формирование│─────►│ • Валидация  │
│   датчик     │     │   запроса     │      │   прав (JWT) │
│ • Выбор      │     │   PUT /sensors│      │ • Проверка   │
│   "История   │     │   /001/status │      │   лимитов    │
│   событий"   │     │ • WebSocket   │      │ • Транзакция │
│              │     │   listen      │      │   в БД       │
└──────────────┘     └───────┬───────┘      └──────┬───────┘
                             │                     │
                      ┌──────▼───────┐       ┌─────▼──────┐
                      │   ВЕБ-       │       │   БАЗА     │
                      │   ИНТЕРФЕЙС  │       │   ДАННЫХ   │
                      │              │◄──────┤            │
                      │ • Обновление │       │ • INSERT   │
                      │   карты      │       │   events   │
                      │ • Уведомления│       │ • UPDATE   │
                      │   в реальном │       │   sensors  │
                      │   времени    │       │ • INSERT   │
                      └──────────────┘       │   audit_log│
                                             └────────────┘
## **6. ТИПОВЫЕ СЦЕНАРИИ РАБОТЫ LLM-АССИСТЕНТА**
### **6.1. КАТЕГОРИИ ЗАПРОСОВ И ОБРАБОТКА**
┌─────────────────────────────────────────────────────────────┐
│          ВХОД: Естественный язык от пользователя            │
│  "Какая общая площадь у арендатора АЗ и где его помещения?" │
└──────────────────────────────┬──────────────────────────────┘
                               │
                ┌──────────────▼─────────────────┐
                │   LLM-СЕРВЕР: АНАЛИЗ И         │
                │   РАЗБИЕНИЕ НА ПОДЗАПРОСЫ      │
                │                                │
                │  1. {"type": "tenant_area",    │
                │      "params": {"tenant":"АЗ"}}│
                │                                │
                │  2. {"type": "tenant_rooms",   │
                │      "params": {"tenant":"АЗ"}}│
                └──────────────┬─────────────────┘
                               │
                ┌──────────────▼─────────────────┐
                │    API-СЕРВЕР: ВЫПОЛНЕНИЕ      │
                │    И АГРЕГАЦИЯ ДАННЫХ          │
                │                                │
                │ • Запрос 1: SUM(area) = 150m²  │
                │ • Запрос 2: [{"room":"101"},   │
                │             {"room":"203"}]    │
                └──────────────┬─────────────────┘
                               │
                ┌──────────────▼────────────────┐
                │   LLM-СЕРВЕР: ФОРМИРОВАНИЕ    │
                │   ЕДИНОГО ОТВЕТА              │
                │                               │
                │ "Арендатор АЗ занимает        │
                │  150 м²: офис 101 (50 м²) и   │
                │  склад 203 (100 м²)."         │
                └───────────────────────────────┘

### **6.2. ТАБЛИЦА ВОЗМОЖНОСТЕЙ LLM-АССИСТЕНТА**
| **Категория** | **Пример запроса** | **Действие LLM** | **Действие API** |
|---------------|-------------------|------------------|------------------|
| **Поиск** | "Где офис АЗ?" | Парсинг → JSON с tenant="АЗ", room_type="office" | JOIN: tenant → placement → room |
| **Статистика** | "Сколько свободных помещений?" | Определение intent="vacant_stats" | COUNT с фильтром status='vacant' |
| **Мониторинг** | "Где сработали датчики?" | Парсинг → {"type":"fire_active"} | SELECT с status='triggered' |
| **Расчёты** | "Стоимость аренды для БЕЗ" | Определение нужных данных | JOIN + вычисление: area × rate |
| **Комбинации** | "Покажи площадь АЗ и статус датчиков там" | Разделение на 2 подзапроса | Параллельные запросы + агрегация |

## **7. ИНТЕРФЕЙСЫ И ВЗАИМОДЕЙСТВИЕ**
### **7.1. ДЕСКТОПНОЕ ПРИЛОЖЕНИЕ (Electron + React)**
┌──────────────────────────────────────────────────────────────┐
│   [ЛОГО] Система управления помещениями v2.0                 │
├──────────────────────────────────────────────────────────────┤
│  Навигация: [Корпуса] [Арендаторы] [Датчики] [Отчёты] [Админ]│
├──────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────────┐    │
│  │                 │  │                                 │    │
│  │  ДЕРЕВО         │  │    ИНТЕРАКТИВНАЯ КАРТА ЭТАЖА    │    │
│  │  ОБЪЕКТОВ       │  │                                 │    │
│  │                 │  │  ┌───┐ ┌───┐    ┌─────┐         │    │
│  │  • Корпус А     │  │  │101│ │102│    │ ДАТЧ│         │    │
│  │    ├─ Этаж 1    │  │  └───┘ └───┘    │ ЧИК │         │    │
│  │    │  ├─ 101    │  │                 └─────┘         │    │
│  │    │  ├─ 102    │  │                                 │    │
│  │    │  └─ Коридор│  │  Легенда:                       │    │
│  │    └─ Этаж 2    │  │  🟢 - норма     🔴 - сработал  │    │
│  │                 │  │  🟡 - отключен  ⚫ - нет связи │    │
│  └─────────────────┘  └─────────────────────────────────┘    │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  ПАНЕЛЬ ДЕТАЛЕЙ: Помещение 101 (Офис)                 │   │
│  │  • Площадь: 50 м²    • Арендатор: АЗ                  │   │
│  │  • Ставка: 1000/м²  • Договор до: 2025-12-31          │   │
│  │  • Датчики: Дымовой #001 (🟢), Тепловой #005 (🟢)    │   │
│  │  [История событий] [Изменить статус] [Отчёт]          │   │
│  └───────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘

### **7.2. TELEGRAM-БОТ ИНТЕРФЕЙС**
┌─────────────────────────────────────────────────────────────┐
│   **Ассистент по помещениям**                               │
│                                                             │
│  Вы: Где находится арендатор АЗ?                            │
│                                                             │
│  Бот: Арендатор "АЗ" занимает:                              │
│       • Корпус А, этаж 1, офис 101 (50 м²)                  │
│       • Корпус Б, этаж 2, склад 203 (100 м²)                │
│       Общая площадь: 150 м²                                 │
│                                                             │
│  ┌────────────────────────────────────────────────────┐     │
│  │  Быстрые команды:                                  │     │
│  │  • /find [арендатор] - найти помещения             │     │
│  │  • /sensors [помещение] - статус датчиков          │     │
│  │  • /report [корпус] - отчёт по свободным площадям  │     │
│  │  • /help - список всех команд                      │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘

## **8. КЛЮЧЕВЫЕ ПРИНЦИПЫ РЕАЛИЗАЦИИ**
1. **Изоляция LLM** — языковая модель работает только с текстом, не имеет доступа к БД и не может выполнять SQL
2. **Единственный источник истины** — все данные хранятся только в PostgreSQL, кеширование через API-сервер
3. **Централизованная бизнес-логика** — все вычисления и проверки выполняются на API-сервере
4. **Real-time обновления** — WebSocket для мгновенного отражения изменений статусов датчиков
5. **Полный аудит** — все изменения фиксируются в audit-логе с указанием пользователя и времени
6. **Масштабируемость** — модульная архитектура позволяет добавлять новых ботов (WhatsApp, VK) через адаптер

Эта архитектура обеспечивает безопасное разделение ответственности между компонентами, где LLM выполняет только функции интеллектуального интерфейса, а вся бизнес-логика и работа с данными централизована в API-сервере.
