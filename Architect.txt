# **Финальная архитектура системы управления помещениями и пожарной сигнализацией**

## **1. ФИЛОСОФИЯ СИСТЕМЫ: ТРИ НЕЗАВИСИМЫХ СЛОЯ РЕАЛЬНОСТИ**

```
┌─────────────────────────────────────────────────────────┐
│                    СИСТЕМА В ЦЕЛОМ                      │
│                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────┐ │
│  │  ФИЗИЧЕСКИЙ     │  │  ЭКОНОМИЧЕСКИЙ  │  │  ЭКСПЛУ-│ │
│  │  МИР            │  │  МИР            │  │  АТАЦИЯ │ │
│  │                 │  │                 │  │         │ │
│  │  • Здания       │  │  • Арендаторы   │  │  • Дат- │ │
│  │  • Этажи        │  │  • Договоры     │  │    чики │ │
│  │  • Помещения    │  │  • Ставки       │  │  • Собы-│ │
│  │  • Зоны         │  │  • Платежи      │  │    тия  │ │
│  │                 │  │                 │  │  • Шины │ │
│  └─────────────────┘  └─────────────────┘  └─────────┘ │
│           │                    │                │       │
│           └────────────────────┼────────────────┘       │
│                                ↓                        │
│                     ┌─────────────────────┐             │
│                     │  РАЗМЕЩЕНИЕ         │             │
│                     │  (связующее звено)  │             │
│                     │  • room_id          │             │
│                     │  • tenant_id        │             │
│                     │  • period           │             │
│                     │  • rate             │             │
│                     └─────────────────────┘             │
└─────────────────────────────────────────────────────────┘
```

**Ключевой принцип:** Каждый слой существует независимо. Только **Размещение** связывает физический и экономический миры. **Датчики** привязаны только к физическому миру.

---

## **2. ФИЗИЧЕСКАЯ АРХИТЕКТУРА (СЕТЕВАЯ)**

```
┌─────────────────────────────────────────────────────────────────┐
│                    ЛОКАЛЬНАЯ СЕТЬ ПРЕДПРИЯТИЯ                   │
│  (все компоненты внутри сети, доступ через VPN для удалённых)   │
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────┐  │
│  │   СЕТЬ БД    │    │  СЕРВИСНАЯ   │    │  КЛИЕНТСКАЯ      │  │
│  │  (изолиро-   │    │  СЕТЬ        │    │  СЕТЬ            │  │
│  │   ванная)    │    │              │    │                  │  │
│  │              │    │  ┌────────┐  │    │  ┌────────────┐  │  │
│  │  [PostgreSQL]│    │  │  API   │  │    │  │  Desktop   │  │  │
│  │      ↑       │    │  │ Server │◄─┼────┼──│  App       │  │  │
│  │      │       │    │  └────────┘  │    │  └────────────┘  │  │
│  │  ┌───┴───┐   │    │        │     │    │        ↑         │  │
│  │  │ Fire- │   │    │  ┌─────▼─────┐   │  │  Пользователи  │  │
│  │  │ wall  │   │    │  │   LLM     │   │  │  в офисе       │  │
│  │  └───┬───┘   │    │  │  Server   │   │  │                │  │
│  │      │       │    │  └─────┬─────┘   │  └────────────────┘  │
│  └──────┼───────┘    │        │         │                     │
│         │            │  ┌─────▼─────┐   │                     │
│         └────────────┼──│   Бот     │   │                     │
│                      │  │  Сервис   │   │                     │
│                      │  └───────────┘   │                     │
│                      └──────────────────┘                     │
│                               │                               │
└───────────────────────────────┼───────────────────────────────┘
                                │
                    ┌───────────▼───────────┐
                    │      DMZ / ПЕРИМЕТР   │
                    │                       │
                    │  ┌─────────────────┐  │
                    │  │   API GATEWAY   │◄─┼── БЕЛЫЙ IP
                    │  │  (Nginx/Traefik)│  │   (для Telegram)
                    │  └─────────────────┘  │
                    │          │             │
                    │  ┌───────▼───────┐    │
                    │  │   VPN Server  │◄───┼── Удалённые админы
                    │  │   (WireGuard) │    │
                    │  └───────────────┘    │
                    └───────────────────────┘
```

---

## **3. ЛОГИЧЕСКАЯ АРХИТЕКТУРА (КОМПОНЕНТЫ)**

### **3.1. ЯДРО СИСТЕМЫ**

```
                      ┌─────────────────┐
                      │   БАЗА ДАННЫХ   │
                      │   PostgreSQL    │
                      │                 │
                      │  Схемы:         │
                      │  • physical     │ ← Здания, этажи, помещения
                      │  • business     │ ← Арендаторы, размещения
                      │  • fire         │ ← Датчики, системы, события
                      │  • audit        │ ← Полный аудит всех изменений
                      │  • cache        │ ← Сессии, кеш запросов
                      └─────────┬───────┘
                                │
                      ┌─────────▼───────┐
                      │   API СЕРВЕР    │
                      │   (единственный │
                      │   доступ к БД)  │
                      │                 │
                      │  • REST API     │
                      │  • WebSocket    │ ← Real-time уведомления
                      │  • Auth/ACL     │ ← Права доступа
                      │  • Бизнес-логика│ ← Валидация, расчёты
                      │  • Агрегаторы   │ ← "Общая площадь", "свободные пом."
                      └─────────┬───────┘
                 ┌──────────────┼──────────────┐
           ┌─────▼─────┐  ┌─────▼─────┐  ┌────▼──────┐
           │   LLM     │  │   БОТ     │  │  DESKTOP  │
           │  СЕРВЕР   │  │  СЕРВИС   │  │   APP     │
           │           │  │           │  │           │
           │  • Парсинг│  │  • Telegram│  │  • Electron│
           │    запроса│  │  • WhatsApp│  │  • React  │
           │  • Генера-│  │  • Голос   │  │  • UI/UX  │
           │    ция от-│  │  • Сессии  │  │  • Карты  │
           │    вета   │  │           │  │  • Отчёты  │
           │  • Whisper│  │           │  │           │
           └───────────┘  └───────────┘  └───────────┘
```

---

## **4. ПОЛНАЯ ОНТОЛОГИЯ СИСТЕМЫ (ЧТО СУЩЕСТВУЕТ)**

### **4.1. ФИЗИЧЕСКИЙ МИР (physical schema)**
```
КОМПЛЕКС (опционально)
    │
    ├── КОРПУС (А, Б, В)             # id, name, floors_count, status
    │       │
    │       ├── ЭТАЖ                  # id, building_id, number, type
    │       │       │
    │       │       ├── ПОМЕЩЕНИЕ     # id, floor_id, number, area, type
    │       │       │       │         # type: office, warehouse, corridor, tech
    │       │       │       │
    │       │       │       └── ЗОНА  # id, room_id, description
    │       │       │                 # (для детализации датчиков)
    │       │       │
    │       │       └── КОРИДОР       # Это ТОЖЕ помещение с type='corridor'
    │       │
    │       └── ТЕХНИЧЕСКИЙ ЭТАЖ     # Ещё один этаж
    │
    └── КОРПУС Б
```

### **4.2. ЭКОНОМИЧЕСКИЙ МИР (business schema)**
```
АРЕНДАТОР                      РАЗМЕЩЕНИЕ (разные периоды)
    │                               │
    ├── Договор 1 ◄─────────────────┤     # placement 1: 2020-2023
    │   (юридическое лицо)          │
    │                               ├──► ПОМЕЩЕНИЕ 101
    ├── Договор 2 ◄─────────────────┤     # placement 2: 2024-...
    │   (тот же арендатор,          │
    │    но новый договор)          │
    │                               ├──► ПОМЕЩЕНИЕ 203
    └── Договор 3 ◄─────────────────┘     # placement 3: параллельно
                                            # rate, usage_type, status
```

**Ключевое:** Один арендатор → несколько размещений → несколько помещений в разное время с разными ставками.

### **4.3. ЭКСПЛУАТАЦИОННЫЙ МИР (fire schema)**
```
СИСТЕМА ПОЖАРНОЙ СИГНАЛИЗАЦИИ
    │
    ├── ШИНА 1 (линия связи)
    │       │
    │       ├── ДАТЧИК ДЫМА #001 ◄──┐
    │       │     │                 │
    │       │     └──► ПОМЕЩЕНИЕ 101│
    │       │                       │
    │       ├── ДАТЧИК ТЕПЛА #002   │
    │       │     │                 │
    │       │     └──► ЗОНА А       ├──► ПОМЕЩЕНИЕ 101
    │       │                       │    (датчики в разных зонах
    │       └── ДАТЧИК РУЧНОЙ #003  │     одного помещения)
    │             │                 │
    │             └──► КОРИДОР 2 эт.┘
    │                   (помещение type='corridor')
    │
    └── ШИНА 2
            │
            └── СОБЫТИЯ ДАТЧИКОВ
                  # (лог всех изменений статуса)
```

---

## **5. ПОТОКИ ДАННЫХ**

### **5.1. ЗАПРОС ЧЕРЕЗ ТЕЛЕГРАМ-БОТА (голос/текст)**

```
ПОЛЬЗОВАТЕЛЬ: "Где офис арендатора АЗ на 3 этаже?"
        ↓
Telegram → Бот-сервис (webhook)
        ↓
[Голос → Текст] (Whisper на LLM-сервере)
        ↓
LLM-сервер: ПАРСИНГ ЗАПРОСА
  Вход: Естественный язык
  Выход: {"intent": "find_tenant_rooms",
          "entities": {"tenant": "АЗ",
                      "floor": 3,
                      "room_type": "office"}}
        ↓
Бот-сервис → API-сервер (структурированный запрос)
        ↓
API-сервер:
  1. Аутентификация (по Telegram ID → роль)
  2. Бизнес-логика:
     • Найти арендатора "АЗ"
     • Найти активные размещения
     • Фильтр: этаж=3, тип помещения=office
  3. Запрос к БД (SQL JOIN через 3 таблицы)
        ↓
БД → Данные: [{"building": "А", "room": "301", "area": 50}, ...]
        ↓
API-сервер → Бот-сервис (JSON с агрегированными данными)
        ↓
Бот-сервис → LLM-сервер: "Сформируй ответ"
        ↓
LLM-сервер: "Арендатор АЗ занимает офис 301 в корпусе А..."
        ↓
Бот-сервис → Telegram → ПОЛЬЗОВАТЕЛЬ
```

### **5.2. ИЗМЕНЕНИЕ СТАТУСА ДАТЧИКА (в десктопном приложении)**

```
ОПЕРАТОР: Кликает "Отключить датчик #001 на техработы"
        ↓
Desktop App → API-сервер: PUT /sensors/001/status
        ↓
API-сервер:
  1. Проверка прав (только инженеры могут отключать)
  2. Валидация:
     • Не отключено ли уже 30% датчиков на этаже?
     • Обязателен комментарий
  3. Транзакция в БД:
     • INSERT в fire.events (новое событие)
     • UPDATE fire.sensors (текущий статус)
     • INSERT в audit.log (кто, когда, почему)
  4. WebSocket broadcast:
     • Desktop App (real-time обновление карты)
     • Бот-сервис (уведомление охране)
        ↓
Ответ → Desktop App (успех/ошибка)
```

---

## **6. ИНТЕРФЕЙСЫ (UI/UX)**

### **6.1. ДЕСКТОПНОЕ ПРИЛОЖЕНИЕ**

```
ГЛАВНОЕ ОКНО (три панели)
┌─────────────────────────────────────────────────────┐
│  [НАВИГАЦИЯ]       │   [КАРТА/СХЕМА]    │ [ДЕТАЛИ]  │
│  Дерево:           │                    │           │
│  ├─ Корпус А       │  Визуализация      │ • Помещ.  │
│  │  ├─ Этаж 1      │  выбранного       │ • Аренд.  │
│  │  │  ├─ 101      │  этажа:           │ • Датчики │
│  │  │  ├─ 102      │  ██ ██ ██ ██      │ • История │
│  │  │  └─ Коридор  │  ██    ██ ██      │           │
│  │  └─ Этаж 2      │  Цвета:           │           │
│  └─ Корпус Б       │  • Зелёный - свободно          │
│                    │  • Синий - арендовано          │
│                    │  • Красный - сработка датчика  │
└─────────────────────────────────────────────────────┘

ВКЛАДКИ:
• Аренда (фильтры: свободные/занятые, по корпусам)
• Пожарка (статусы датчиков, статистика отключений)
• Отчёты (PDF/CSV: площади, задолженности, инциденты)
• Админ (CRUD всех сущностей, пользователи, роли)
```

### **6.2. ТЕЛЕГРАМ-БОТ (примеры диалога)**

```
Пользователь: Где находится арендатор АЗ?
Бот: Арендатор "АЗ" занимает:
     • Корпус А, этаж 3, офис 301 (50 м²)
     • Корпус Б, этаж -1, склад B12 (200 м²)

Пользователь: Какой датчик в коридоре 4 этажа Б?
Бот: В коридоре 4 этажа корпуса Б:
     • Датчик #F203 (дымовой), шина 4, адрес 12
     • Статус: норма ⚪
     • Последняя проверка: 15.03.2024

Пользователь: (голос) Какая общая площадь у БЕЗ?
Бот: Общая площадь арендатора "БЕЗ": 450 м²
     • Офисы: 150 м² (корпус А)
     • Склады: 300 м² (корпус В)
```

---

## **7. БЕЗОПАСНОСТЬ И АУДИТ**

### **7.1. УРОВНИ ДОСТУПА**

```
         ┌─────────────────┐
         │    АДМИНИСТРАТОР│ ← Полный доступ, управление пользователями
         └─────────┬───────┘
                   │
         ┌─────────▼───────┐
         │    ИНЖЕНЕР      │ ← Управление датчиками, отключения
         └─────────┬───────┘
                   │
         ┌─────────▼───────┐
         │    ОХРАНА       │ ← Просмотр статусов датчиков, получение алертов
         └─────────┬───────┘
                   │
         ┌─────────▼───────┐
         │    МЕНЕДЖЕР     │ ← Просмотр аренды, площадей
         └─────────┬───────┘
                   │
         ┌─────────▼───────┐
         │    АРЕНДАТОР    │ ← Только свои помещения (через бота)
         └─────────────────┘
```

### **7.2. ПОЛНЫЙ АУДИТ (audit.log)**

Каждое действие фиксируется:
```
• Кто (user_id, роль)
• Когда (timestamp с микросекундами)
• Что (действие: create/update/delete)
• Объект (таблица, id записи)
• Старое/новое значение
• IP/устройство
• Сессия/запрос
```

---

## **8. РАСШИРЕНИЕ СИСТЕМЫ**

### **8.1. ГОРИЗОНТАЛЬНОЕ (больше данных)**
```
• Новые корпуса → просто записи в БД
• Новые типы датчиков → enum в схеме
• Новые мессенджеры → адаптер в бот-сервисе
```

### **8.2. ВЕРТИКАЛЬНОЕ (новая функциональность)**
```
• IoT интеграция → подписка на MQTT от датчиков
• Календарь бронирования → для переговорных
• Умный учёт ресурсов (электричество, вода)
• Мобильное приложение для обходов охраны
• Интеграция с 1С для бухгалтерии
```

---

## **9. КЛЮЧЕВЫЕ ПРИНЦИПЫ АРХИТЕКТУРЫ**

1. **РАЗДЕЛЕНИЕ СЛОЁВ**: Физический, экономический, эксплуатационный миры независимы
2. **ИСТОРИЧНОСТЬ**: Всё что меняется (ставки, статусы, аренда) имеет историю
3. **ИЗОЛЯЦИЯ**: БД доступна только API-серверу, LLM не видит БД
4. **АУДИТ ВСЕГО**: Каждое изменение фиксируется, нельзя удалить данные
5. **REAL-TIME**: WebSocket для мгновенных уведомлений о критичных событиях
6. **ЕДИНСТВЕННОСТЬ ИСТИНЫ**: Данные только в БД, кеш — временный
7. **РОЛЕВАЯ МОДЕЛЬ**: Чёткие границы доступа на всех уровнях
8. **КОНТЕЙНЕРИЗАЦИЯ**: Каждый компонент в Docker, оркестрация через Docker Compose/K8s

---

Эта архитектура обеспечивает:
- **Безопасность** через изоляцию и аудит
- **Гибкость** через чистую онтологию
- **Масштабируемость** через микросервисный подход
- **Удобство** через голосовой интерфейс и визуализацию
- **Надёжность** через транзакции и резервное копирование
