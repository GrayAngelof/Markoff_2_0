# Система управления недвижимостью с голосовым ассистентом и мониторингом пожарной сигнализации

Вот как система работает, начиная с архитектуры и заканчивая выполнением запросов.

---

## **1. Общая архитектура и подготовка**

Все компоненты системы работают внутри локальной сети компании. Белый IP-адрес используется только для безопасного взаимодействия Telegram-бота с внешним API-шлюзом. Принципиальные решения:

*   **Безопасность и изоляция**: База данных (PostgreSQL) недоступна напрямую извне. Весь доступ к ней осуществляется **исключительно через API-сервер**. Сервер с языковой моделью (LLM) используется только для обработки естественного языка (NLP) и не имеет прямого доступа к БД или права выполнения SQL-запросов.
*   **Масштабируемость**: Архитектура позволяет в будущем подключать ботов для других мессенджеров через унифицированный слой-адаптер.

**Ключевые компоненты системы:**

| Компонент | Роль и ответственность |
| :--- | :--- |
| **База данных (PostgreSQL)** | Единственный источник истины. Хранит все структурированные данные о корпусах, помещениях, арендаторах и датчиках пожарной сигнализации. |
| **API-сервер** | Центральный хаб системы. Обрабатывает все структурированные запросы к данным, обеспечивает аутентификацию (по токенам или ролям) и бизнес-логику. |
| **LLM-сервер (AI Model Server)** | "Интеллектуальный переводчик". Парсит запросы с естественного языка в структурированные команды для API и формирует понятные текстовые ответы на основе данных. Работает локально. |
| **Десктопное приложение** | Полнофункциональный клиент для администраторов и менеджеров. Отображает интерактивные планы, таблицы и дашборды. |
| **Telegram-бот** | Мобильный и голосовой интерфейс для быстрых запросов. Интегрируется с внешним Telegram API. |

**Подготовка к работе:**
При запуске все сервисы инициализируются. API-сервер подключается к БД, LLM-сервер загружает модель и инструкции (промпт), где описана его роль ассистента по управлению недвижимостью и мониторингу пожарной сигнализации. Система готова принимать запросы.

---

## **2. Пользовательский запрос через Telegram-бота (Текст или Голос)**

**Сценарий:** Сотрудник охраны в Telegram-боте отправляет голосовое сообщение: *"Где находится арендатор АЗ?"*

### **Шаг 1: Приём и преобразование запроса**
1. Telegram-бот принимает голосовое сообщение.
2. **Локальный модуль speech-to-text** (например, на базе Whisper) преобразует аудио в текст: `"Где находится арендатор АЗ?"`.
3. Бот отправляет этот текстовый запрос на **LLM-сервер** для анализа намерения.

### **Шаг 2: Парсинг и понимание намерения (Работа LLM)**
*   LLM-сервер анализирует фразу, используя заранее заданный промпт. Его задача — не генерировать данные, а **преобразовать запрос в структурированный формат** для API.
*   Результат — чёткий JSON-объект, например:
    json
    {
      "type": "tenant_location",
      "parameters": {"tenant_name": "АЗ"}
    }
    
*   LLM определяет, что для ответа нужен запрос к API для поиска помещений арендатора.

### **Шаг 3: Выполнение запроса к данным (Работа API и БД)**
1. Бот отправляет структурированный JSON-запрос в **API-сервер**, добавляя данные для аутентификации пользователя (например, Telegram ID).
2. API-сервер проверяет права пользователя, выполняет соответствующие SQL-запросы к БД (PostgreSQL) и получает "сырые" данные. Например:
    ```json
    [{"building": "Корпус А", "floor": 1, "room": "101", "type": "офис", "area": 50},
     {"building": "Корпус Б", "floor": 2, "room": "203", "type": "склад", "area": 100}]
    ```

### **Шаг 4: Формирование и отправка ответа**
1. API возвращает данные боту, который передаёт их обратно в **LLM-сервер**.
2. LLM получает промпт: *"Сформируй естественный, аккуратный ответ на основе этих данных."*
3. Модель генерирует понятный текст: *"Арендатор АЗ занимает офис в Корпусе А, этаж 1, помещение 101 (50 кв. м) и склад в Корпусе Б, этаж 2, помещение 203 (100 кв. м)."*
4. Бот отправляет этот текст пользователю в Telegram.

**Весь процесс, от голосового сообщения до ответа, занимает несколько секунд.**

---

## **3. Работа администратора в десктопном приложении**

**Сценарий:** Менеджер в десктопном приложении видит на плане этажа, что статус датчика в помещении Б-305 изменился на "Сработало". Он кликает на него, чтобы посмотреть историю событий.

### **Логика работы:**
1. Десктопное приложение — это standalone-клиент с графическим интерфейсом. Оно **не обращается к LLM** для рутинных операций.
2. Приложение знает, какие API-эндпоинты использовать для каждого действия. Для получения истории датчика оно отправляет прямой HTTP-запрос:
    `GET /api/fire_alarms/705/event_log`
3. **API-сервер** принимает запрос, проверяет JWT-токен менеджера, выполняет запрос к БД `EventLogs` и возвращает структурированные данные приложению.
4. Приложение отображает историю событий в отдельном окне или таблице.

### **Ключевой функционал десктопного приложения:**
*   **Навигация и поиск**: Древовидный вид (Корпус → Этаж → Помещения), фильтры, поиск по арендаторам.
*   **Управление арендаторами**: Просмотр списков, расчёт общей площади и стоимости аренды для каждого.
*   **Мониторинг пожарной сигнализации**:
    *   Дашборд со статистикой (количество сработавших/отключенных датчиков).
    *   Поиск датчика по ID или местоположению.
    *   Просмотр истории событий и графиков по отключениям.
*   **Администрирование**: Полное управление данными (CRUD для корпусов, помещений, арендаторов, датчиков), экспорт отчётов.
*   **Real-time уведомления**: При изменении статуса любого датчика пожарной сигнализации API-сервер может отправлять мгновенные push-уведомления на десктоп через WebSocket-соединение.

## **4. Типовые запросы к голосовому ассистенту (Telegram-бот)**

Система через LLM умеет парсить и обрабатывать широкий спектр запросов:

| Категория запроса | Пример голосовой/текстовой команды | Что делает система |
| **Поиск арендаторов и помещений** | "Где находится арендатор БЕЗ?" | Находит и перечисляет все помещения арендатора. |
| | "Какая общая площадь у арендатора АЗ?" | Суммирует площади всех его помещений. |
| | "Покажи свободные офисы в Корпусе В." | Фильтрует помещения по статусу и типу. |
| **Мониторинг пожарной сигнализации** | "Как подключен датчик в коридоре 4 этажа Корпуса Б?" | Возвращает номер устройства, шину подключения и статус. |
| | "Статистика отключений по помещению 101 в Корпусе А." | Анализирует логи событий за период. |
| | "Где прямо сейчас сработали датчики?" | Ищет все датчики со статусом "Сработало". |
| **Комбинированные запросы** | "Покажи площадь офиса арендатора АЗ и статус датчика там." | LLM парсит запрос на два подзапроса, API агрегирует данные, LLM формирует единый ответ. |

---

## **5. Принципы работы и интеграции**

1.  **Чёткое разделение ответственности**:
    *   **LLM (ИИ) — Переводчик и оформитель**. Ничего не изменяет в системе, не имеет доступа к БД. Только парсит "человеческий" язык в JSON и красиво оформляет ответы.
    *   **API-сервер — Единственный исполнитель**. Все операции с данными (чтение, запись, бизнес-логика) проходят через него. Он гарантирует безопасность, аудит и целостность данных.
    *   **База данных (PostgreSQL) — Единственный источник истины**. Все актуальные данные хранятся здесь.

2.  **Поток данных**:
    *   **Запрос**: Пользователь → (Голос → Текст) → LLM (Парсинг в JSON) → API-сервер (Валидация и SQL) → БД.
    *   **Ответ**: БД → API-сервер (Структурированные данные) → LLM (Форматирование текста) → Пользователь.

3.  **Безопасность**:
    *   Аутентификация по JWT-токенам или ролям пользователей.
    *   Пользователь бота может быть ограничен в данных (например, видеть только "свои" помещения).
    *   LLM-сервер изолирован в сети и не может инициировать запросы к БД.

**Итог**: Система объединяет надёжность реляционной базы данных, безопасность централизованного API и удобство современного голосового и визуального интерфейсов, делая управление комплексом интуитивным и эффективным.
