# Архитектура системы интеллектуального управления объектами

1. СИСТЕМНАЯ ФИЛОСОФИЯ: "УМНЫЙ ПРОВОДНИК"
Центральный принцип:
Система построена на идее полной изоляции данных от интеллектуального интерфейса.
Nanobot (ИИ-агент) выполняет роль «умного проводника» или «переводчика», который понимает естественную речь пользователя, формулирует на её основе структурированные запросы к системе, но никогда не имеет прямого доступа к базе данных или исполняющему коду.

Все операции с данными проходят через единый, контролируемый и безопасный канал — API-сервер. Это гарантирует целостность данных, безопасность и упрощает аудит всех действий.

ПОТОК ДАННЫХ (СТРОГО РЕГЛАМЕНТИРОВАН):
┌──────────────┐    ┌──────────┐    ┌────────────┐    ┌────────────┐     ┌──────────────┐    ┌────────────┐    ┌─────────┐    ┌──────────────┐
│ ПОЛЬЗОВАТЕЛЬ │ ─► │ Nanobot  │ ─► │ API-Сервер │ ─► │   БД       │ ─►  │ API-Сервер   │ ─► │ API-Сервер │ ─► │ Nanobot │ ─► │ ПОЛЬЗОВАТЕЛЬ │
│   Запрос     │    │ Анализ,  │    │ Исполнение │    │ PostgreSQL │     │ Формирование │    │ Передача   │    │ Синтез  │    │ Ответ        │
│              │    │ Планиро- │    │            │    │            │     │   ответа     │    │ данных     │    │ ответа  │    │              │
│              │    │  вание   │    │            │    │            │     │              │    │            │    │         │    │              │
└──────────────┘    └──────────┘    └────────────┘    └────────────┘     └──────────────┘    └────────────┘    └─────────┘    └──────────────┘
 
2. ЛОГИЧЕСКАЯ АРХИТЕКТУРА КОМПОНЕНТОВ

## **2. СЕТЕВАЯ АРХИТЕКТУРА С ИЗОЛЯЦИЕЙ КОМПОНЕНТОВ**
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ВНЕШНЯЯ СЕТЬ / ИНТЕРНЕТ                                  │
│  (Доступ для удаленных пользователей и Telegram Bot API)                    │
└───────────────────────────▲─────────────────────────────────────────────────┘
                            │ (HTTPS / WebSocket)
                    ┌───────▼─────────────────────────────────────┐
                    │        ДЕМАРКИРОВАННАЯ ЗОНА (DMZ)           │
                    │   Минимальная поверхность атаки             │
                    │ ┌─────────────────────────────────────────┐ │
                    │ │         ОБРАТНЫЙ ПРОКСИ / API GATEWAY   │ │
                    │ │   • Nginx / Traefik                     │ │
                    │ │   • SSL Termination                     │ │
                    │ │   • Базовая маршрутизация и защита      │ │
                    │ │   • Публичный IP-адрес (Белый IP)       │ │
                    │ └───────────────▲─────────────────────────┘ │
                    │                 │ Внутренний маршрут        │
                    └─────────────────┼───────────────────────────┘
                                      │
┌─────────────────────────────────────▼─────────────────────────────────────┐
│                    ВНУТРЕННЯЯ СЕРВИСНАЯ СЕТЬ (LAN)                        │
│  Все компоненты изолированы от прямого доступа из Интернета               │
│                                                                           │
│ ┌───────────────────────────────────────────────────────────────────────┐ │
│ │                    КЛИЕНТСКИЙ ШЛЮЗ / АДАПТЕР                          │ │
│ │  • Python-сервис (например, на FastAPI)                               │ │
│ │  • Принимает входящие запросы от DMZ (через прокси).                  │ │
│ │  • Определяет тип запроса:                                            │ │
│ │      → Если запрос к API (UI, бот) -> маршрутизирует в API-сервер.    │ │
│ │      → Если запрос для NANOBOT -> маршрутизирует в NANOBOT.           │ │
│ │  • Никакой бизнес-логики, только маршрутизация.                       │ │
│ └──────▲────────────────────────▲───────────────────────────────────────┘ │
│        │                        │                                         │
│        │                        │                                         │
│        │                        │                                         │
│        │                        │                                         │
│        │ Запрос для Nanobot     │ Запрос для API                          │
│ ┌──────▼────────┐      ┌────────▼────────┐      ┌───────────────────────┐ │
│ │   NANOBOT     │◄────►│   API-СЕРВЕР    │◄────►│   БАЗА ДАННЫХ (БД)    │ │
│ │   (СЕРВИС)    │      │   (СЕРВИС)      │      │   PostgreSQL          │ │
│ │               │      │                 │      │                       │ │
│ │ • LLM на      │      │ • FastAPI/      │      │ • Сетевой доступ      │ │
│ │   RTX 5090    │      │   Flask         │      │   ТОЛЬКО для          │ │
│ │ • Слушает     │      │ • JWT Auth      │      │   API-сервера.        │ │
│ │   внутренний  │      │ • Бизнес-       │      │ • Изолированная       │ │
│ │   порт        │      │   логика        │      │   подсеть/VLAN.       │ │
│ │ • Отвечает    │      │ • Валидация     │      │                       │ │
│ │   ТОЛЬКО      │      │   данных        │      │                       │ │
│ │   API-серверу │      │ • Выполняет     │      │                       │ │
│ │               │      │   SQL-запросы   │      │                       │ │
│ └───────▲───────┘      └────────▲────────┘      └───────────────────────┘ │
│         └───────────────────────┘                                         │
│                  Внутренний REST/WebSocket                                │
│                  (закрытая сеть, нет выхода наружу)                       │
│                                                                           │
│  Примечание: Прямого пути Пользователь->Nanobot НЕТ. Весь трафик идет     │
│  через Клиентский шлюз, который направляет его в нужный сервис.           │
│  Это обеспечивает контроль, логирование и безопасность.                   │
└───────────────────────────────────────────────────────────────────────────┘

## **3. ЛОГИЧЕСКАЯ АРХИТЕКТУРА КОМПОНЕНТОВ**
                    ┌─────────────────────────────────────────────────────────┐
                    │          КЛИЕНТСКИЕ ИНТЕРФЕЙСЫ (Frontend)               │
                    │  • Точка входа для пользователя.                        │
                    │  • Отправляет сырой запрос от пользователя в систему.   │
                    └───────────────────────▲─────────────────────────────────┘
                                            │ (HTTP/WebSocket Запрос)
                    ┌───────────────────────▼─────────────────────────────────┐
                    │           ИНТЕЛЛЕКТУАЛЬНЫЙ СЛОЙ (Nanobot Agent)         │
                    │  • Автономный сервис, работающий на NVIDIA RTX 5090.    │
                    │  • Получает ТЕКСТОВЫЙ запрос от API-сервера.            │
                    │  • Задачи:                                              │
                    │    1. Понимание намерения (NLU).                        │
                    │    2. Планирование последовательности вызовов API.      │
                    │    3. Формирование структурированного JSON-запроса      │
                    │       для API-сервера.                                  │
                    │    4. Синтез итогового ответа на основе данных от API.  │
                    │  • Работает только с описанием (спецификацией) API,     │
                    │    предоставленным бэкендом.                            │
                    └───────────────────────┬─────────────────────────────────┘
                                            │ (Структурированный JSON)
                    ┌───────────────────────▼─────────────────────────────────┐
                    │           ИСПОЛНИТЕЛЬНЫЙ СЛОЙ (Python Backend & API)    │
                    │  • Центральный хаб и единственный шлюз к данным.        │
                    │  • Основные функции:                                    │
                    │    - Приём запросов от клиентов.                        │
                    │    - Взаимодействие с Nanobot (отправка текста запроса, │
                    │      получение плана действий).                         │
                    │    - ВАЛИДАЦИЯ и безопасное исполнение плана от Nanobot.│
                    │    - Выполнение бизнес-логики и запросов к БД.          │
                    │    - Формирование ответов для клиента (текст + схема).  │
                    │    - Управление аутентификацией и аудитом.              │
                    └───────────────────────┬─────────────────────────────────┘
                                            │ (SQL-запросы через ORM)
                    ┌───────────────────────▼─────────────────────────────────┐
                    │           СЛОЙ ДАННЫХ (PostgreSQL)                      │
                    │  • Единый источник истины.                              │
                    │  • Схемы:                                               │
                    │    - `physical`: Здания, этажи, помещения, схемы.       │
                    │    - `business`: Арендаторы, договоры, размещения.      │
                    │    - `fire`: Датчики, их статусы, события.              │
                    │    - `audit`: Логи всех действий системы.               │
                    └─────────────────────────────────────────────────────────┘
## **4. ОБНОВЛЕННАЯ ОНТОЛОГИЯ СИСТЕМЫ**
### **4.1. ФИЗИЧЕСКИЙ МИР (physical_schema)**
КОМПЛЕКС (опциональная группировка)
    │
    ├── КОРПУС (id, name, floors_count, status)
    │       │
    │       ├── ЭТАЖ (id, building_id, number, type)
    │       │       │
    │       │       ├── ПОМЕЩЕНИЕ (id, floor_id, number, area, type)
    │       │       │       │      # type: office, warehouse, corridor, tech
    │       │       │       │
    │       │       │       └── ЗОНА (id, room_id, description)
    │       │       │                 # для детализации размещения датчиков
    │       │       │
    │       │       └── КОРИДОР (это помещение с type='corridor')
    │       │
    │       └── ТЕХНИЧЕСКИЙ ЭТАЖ (type='technical')

### **4.2. БИЗНЕС-ЛОГИКА (business_schema)**
АРЕНДАТОР (id, name, legal_info, contact)
    │
    ├── ДОГОВОР 1 (id, tenant_id, start_date, end_date)
    │       │
    │       └── РАЗМЕЩЕНИЕ 1 (id, contract_id, room_id, rate, status)
    │               │
    │               └──► ПОМЕЩЕНИЕ 101
    │
    ├── ДОГОВОР 2 (тот же арендатор, новый период)
    │       │
    │       └── РАЗМЕЩЕНИЕ 2 (параллельное размещение)
    │               │
    │               └──► ПОМЕЩЕНИЕ 203
    │
    └── РАСЧЁТЫ (связь с размещениями для финансовой отчётности)

### **4.3. МОНИТОРИНГ (fire_schema)**
СИСТЕМА ПОЖАРНОЙ СИГНАЛИЗАЦИИ
    │
    ├── ШИНА 1 (линия связи, id, description)
    │       │
    │       ├── ДАТЧИК ДЫМА #001 (id, bus_id, room_id, zone_id, status)
    │       │       │
    │       │       └──► СОБЫТИЯ (timestamp, old_status, new_status, comment)
    │       │
    │       ├── ДАТЧИК ТЕПЛА #002 (привязан к зоне внутри помещения)
    │       │
    │       └── ДАТЧИК РУЧНОЙ #003 (в коридоре - помещении type='corridor')
    │
    └── АВАРИЙНЫЕ СЦЕНАРИИ (правила автоматических уведомлений)

## **5. ПОТОКИ ДАННЫХ И ВЗАИМОДЕЙСТВИЕ**
### **5.1. ЗАПРОС ЧЕРЕЗ ТЕЛЕГРАМ-БОТА (голос/текст)**
┌────────────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ ПОЛЬЗОВАТЕЛЬ   │     │ Telegram  │     │ БОТ-      │     │ LLM-      │
│ "Где офис      │────►│   Бот     │────►│ СЕРВИС    │────►│ СЕРВЕР    │
│ арендатора     │     │           │     │           │     │           │
│ АЗ на 3 этаже?"│     │           │     │           │     │           │
└────────────────┘     └───────────┘     └───┬───────┘     └─────┬─────┘
        Голос → Текст (Whisper)              │                   │Парсинг NLP
                                             │                   │
                                      ┌──────▼──────┐  ┌─────────▼────┐
                                      │   API-      │  │ JSON-струк-  │
                                      │   СЕРВЕР    │  │ тура запроса:│
                                      │             │  │ {            │
                                      │ • Аутенти-  │  │   "type":    │
                                      │   фикация   │◄─┤   "find_     │
                                      │ • SQL-запрос│  │   tenant",   │
                                      │ • Бизнес-   │  │   "params": {│
                                      │   логика    │  │     "tenant":│
                                      └──────┬──────┘  │     "АЗ",    │
                                             │         │     "floor":3│
                                      ┌──────▼──────┐  │   }          │
                                      │   БАЗА      │  └──────────────┘
                                      │   ДАННЫХ    │
                                      │   (PostgreSQL)
                                      └──────┬──────┘
                                             │
                                      ┌──────▼──────┐     ┌──────────────┐
                                      │   LLM-      │     │ ПОЛЬЗОВАТЕЛЬ │
                                      │   СЕРВЕР    │────►│   (ответ)    │
                                      │             │     │              │
                                      │ • Генерация │     │ "Арендатор   │
                                      │   ответа    │     │ АЗ занимает  │
                                      │ • Формати-  │     │ офис 301     │
                                      │   рование   │     │ в корпусе А  │
                                      └─────────────┘     │ ..."         │
                                                          └──────────────┘

### **5.2. РАБОТА В ДЕСКТОПНОМ ПРИЛОЖЕНИИ**
┌──────────────┐     ┌───────────────┐      ┌──────────────┐
│  ОПЕРАТОР    │     │  DESKTOP APP  │      │  API-СЕРВЕР  │
│  (администра-│     │  (Electron/   │      │              │
│   тор)       │     │   React)      │      │              │
│              │     │               │      │              │
│ • Клик на    │────►│ • Формирование│─────►│ • Валидация  │
│   датчик     │     │   запроса     │      │   прав (JWT) │
│ • Выбор      │     │   PUT /sensors│      │ • Проверка   │
│   "История   │     │   /001/status │      │   лимитов    │
│   событий"   │     │ • WebSocket   │      │ • Транзакция │
│              │     │   listen      │      │   в БД       │
└──────────────┘     └───────┬───────┘      └──────┬───────┘
                             │                     │
                      ┌──────▼───────┐       ┌─────▼──────┐
                      │   ВЕБ-       │       │   БАЗА     │
                      │   ИНТЕРФЕЙС  │       │   ДАННЫХ   │
                      │              │◄──────┤            │
                      │ • Обновление │       │ • INSERT   │
                      │   карты      │       │   events   │
                      │ • Уведомления│       │ • UPDATE   │
                      │   в реальном │       │   sensors  │
                      │   времени    │       │ • INSERT   │
                      └──────────────┘       │   audit_log│
                                             └────────────┘
## **6. ТИПОВЫЕ СЦЕНАРИИ РАБОТЫ LLM-АССИСТЕНТА**
### **6.1. КАТЕГОРИИ ЗАПРОСОВ И ОБРАБОТКА**
┌─────────────────────────────────────────────────────────────┐
│          ВХОД: Естественный язык от пользователя            │
│  "Какая общая площадь у арендатора АЗ и где его помещения?" │
└──────────────────────────────┬──────────────────────────────┘
                               │
                ┌──────────────▼─────────────────┐
                │   LLM-СЕРВЕР: АНАЛИЗ И         │
                │   РАЗБИЕНИЕ НА ПОДЗАПРОСЫ      │
                │                                │
                │  1. {"type": "tenant_area",    │
                │      "params": {"tenant":"АЗ"}}│
                │                                │
                │  2. {"type": "tenant_rooms",   │
                │      "params": {"tenant":"АЗ"}}│
                └──────────────┬─────────────────┘
                               │
                ┌──────────────▼─────────────────┐
                │    API-СЕРВЕР: ВЫПОЛНЕНИЕ      │
                │    И АГРЕГАЦИЯ ДАННЫХ          │
                │                                │
                │ • Запрос 1: SUM(area) = 150m²  │
                │ • Запрос 2: [{"room":"101"},   │
                │             {"room":"203"}]    │
                └──────────────┬─────────────────┘
                               │
                ┌──────────────▼────────────────┐
                │   LLM-СЕРВЕР: ФОРМИРОВАНИЕ    │
                │   ЕДИНОГО ОТВЕТА              │
                │                               │
                │ "Арендатор АЗ занимает        │
                │  150 м²: офис 101 (50 м²) и   │
                │  склад 203 (100 м²)."         │
                └───────────────────────────────┘

### **6.2. ТАБЛИЦА ВОЗМОЖНОСТЕЙ LLM-АССИСТЕНТА**
| **Категория** | **Пример запроса** | **Действие LLM** | **Действие API** |
|---------------|-------------------|------------------|------------------|
| **Поиск** | "Где офис АЗ?" | Парсинг → JSON с tenant="АЗ", room_type="office" | JOIN: tenant → placement → room |
| **Статистика** | "Сколько свободных помещений?" | Определение intent="vacant_stats" | COUNT с фильтром status='vacant' |
| **Мониторинг** | "Где сработали датчики?" | Парсинг → {"type":"fire_active"} | SELECT с status='triggered' |
| **Расчёты** | "Стоимость аренды для БЕЗ" | Определение нужных данных | JOIN + вычисление: area × rate |
| **Комбинации** | "Покажи площадь АЗ и статус датчиков там" | Разделение на 2 подзапроса | Параллельные запросы + агрегация |

## **7. ИНТЕРФЕЙСЫ И ВЗАИМОДЕЙСТВИЕ**
### **7.1. ДЕСКТОПНОЕ ПРИЛОЖЕНИЕ (Electron + React)**
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│   [ЛОГО] Система управления помещениями                                                      │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│  Навигация: [Объекты] [Поиск] [Арендаторы] [Отчёты] [Админ] [ИИ-помощник]                    │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐  ┌────────────────────────────────────────────────────────────────┐  │
│  │                    │  │       [ Вкладка: 🏢 Аренда | 🔥 Пожарная безопасность ]       │  │
│  │  (ДЕРЕВО           │  ├────────────────────────────────────────────────────────────────┤  │
│  │  ОБЪЕКТОВ)         │  │                                                                │  │
│  │ - Компл. 1         │  │  ИНТЕРАКТИВНАЯ КАРТА ЭТАЖА                                     │  │
│  │   ├ Корпус А       │  │                                                                │  │
│  │   │  ├─ Этаж 1     │  │  ┌───┐ ┌───┐    ┌─────┐         ┌────────────────────────────┐ │  │
│  │   │  │  ├─ 101     │  │  │101│ │102│    │ ДАТЧ│         │       Легенда              │ │  │
│  │   │  │  ├─ 102     │  │  └───┘ └───┘    │ ЧИК │         │  🟢 Норма | 🔴 Тревога    │ │  │
│  │   │  │  └─ Коридор │  │                 └─────┘         │  🟡 Отключ.| ⚫ Нет связи │ │  │
│  │   │  └─ Этаж 2     │  │                                 │                            │ │  │
│  │   └ Корпус Б       │  │                                 └────────────────────────────┘ │  │
│  │ - Компл. 2         │  │                                                                │  │
│  │    └ Здание        │  │                                                                │  │
│  │      └ Этаж 1      │  │                                                                │  │
│  │        ├─ 101      │  │                                                                │  │
│  │        └─ Коридор  │  └────────────────────────────────────────────────────────────────┘  │
│  └────────────────────┘                                                                      │ 
│                                                                                              │
│  (Клик по объекту обновляет карту и панель вкладок)                                          │
│                                                                                              │
│                                                                                              │
│  ┌───────────────────────────────────────────────────────┐                                   │
│  │  ПАНЕЛЬ ДЕТАЛЕЙ: Помещение 101 (Офис)                 │                                   │
│  │  • Площадь: 50 м²    • Арендатор: АЗ                  │                                   │
│  │  • Датчики: Дымовой #001 (🟢), Тепловой #005 (🟢)    │                                   │
│  │  [История событий] [Изменить статус] [Отчёт]          │                                   │
│  └───────────────────────────────────────────────────────┘                                   │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
Ключевая логика работы:
Вкладки «Аренда | Пожарная безопасность»:
Карта этажа является общей и отображается постоянно. Это связующий элемент — пользователь всегда видит физическое расположение.
Вкладки переключают нижнюю панель деталей. Вся информация о выбранном объекте разделена на два четких блока.

Динамическое обновление:
При клике на объект в дереве (например, "Помещение 101") происходит три действия:
На карте этажа подсвечивается выбранное помещение.
Панель деталей обновляется, показывая информацию именно об этом объекте.
Внутри панели данные автоматически распределяются по вкладкам «Аренда» и «Пожарка».
Улучшенная навигация:

Кнопка «ИИ-помощник» в верхней панели. При нажатии открывается боковая панель или окно чата, где пользователь может задать вопрос голосом или текстом (реализует ваш основной поток Пользователь -> nanobot -> ...).

Кнопка «Поиск» позволяет быстро найти арендатора, помещение или датчик.

Состояние в реальном времени:
На карте этажа статус каждого помещения/датчика отображается цветом (🟢🔴🟡⚫), как в легенде.

В панели «Пожарная безопасность» отображается общий сводный статус помещения (определяется по худшему статусу среди датчиков) и детальный список всех датчиков с датами последних проверок.

### **7.2. TELEGRAM-БОТ ИНТЕРФЕЙС**
┌─────────────────────────────────────────────────────────────┐
│   **Ассистент по помещениям**                               │
│                                                             │
│  Вы: Где находится арендатор АЗ?                            │
│                                                             │
│  Бот: Арендатор "АЗ" занимает:                              │
│       • Корпус А, этаж 1, офис 101 (50 м²)                  │
│       • Корпус Б, этаж 2, склад 203 (100 м²)                │
│       Общая площадь: 150 м²                                 │
│                                                             │
│  ┌────────────────────────────────────────────────────┐     │
│  │  Быстрые команды:                                  │     │
│  │  • /find [арендатор] - найти помещения             │     │
│  │  • /sensors [помещение] - статус датчиков          │     │
│  │  • /report [корпус] - отчёт по свободным площадям  │     │
│  │  • /help - список всех команд                      │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘

## **8. КЛЮЧЕВЫЕ ПРИНЦИПЫ РЕАЛИЗАЦИИ**
1. **Изоляция LLM** — языковая модель работает только с текстом, не имеет доступа к БД и не может выполнять SQL
2. **Единственный источник истины** — все данные хранятся только в PostgreSQL, кеширование через API-сервер
3. **Централизованная бизнес-логика** — все вычисления и проверки выполняются на API-сервере
4. **Real-time обновления** — WebSocket для мгновенного отражения изменений статусов датчиков
5. **Полный аудит** — все изменения фиксируются в audit-логе с указанием пользователя и времени
6. **Масштабируемость** — модульная архитектура позволяет добавлять новых ботов (WhatsApp, VK) через адаптер

Эта архитектура обеспечивает безопасное разделение ответственности между компонентами, где LLM выполняет только функции интеллектуального интерфейса, а вся бизнес-логика и работа с данными централизована в API-сервере.
