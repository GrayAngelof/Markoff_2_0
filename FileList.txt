Markoff_2.0/
├── config/                          # Конфиги (секреты, настройки LLM, каналов, БД)
│   ├── .env                         # Общие переменные: DATABASE_URL, LLM_BASE_URL и т.д.
│   ├── backend.env                  # Только для backend (если разделяем)
│   ├── nanobot_config.json          # Конфиг Nanobot: providers (openai → Koboldcpp), channels (telegram), skills
│   └── logging.yaml                 # Настройки логирования
│
├── backend/                         # FastAPI + SQLAlchemy + доступ к PostgreSQL (в контейнере)
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py                  # uvicorn app = FastAPI()
│   │   ├── api/
│   │   │   ├── routers/
│   │   │   │   ├── buildings.py
│   │   │   │   ├── tenants.py
│   │   │   │   ├── sensors.py
│   │   │   │   └── health.py        # /health, /ready
│   │   │   └── dependencies.py      # get_db, get_current_user, rate_limit
│   │   ├── db/
│   │   │   ├── models/              # SQLAlchemy модели
│   │   │   │   ├── building.py
│   │   │   │   ├── tenant.py
│   │   │   │   └── sensor.py
│   │   │   ├── crud/
│   │   │   ├── migrations/          # alembic
│   │   │   └── session.py
│   │   └── utils/
│   │       ├── visualization.py     # Pillow для схем этажей
│   │       └── helpers.py
│   └── requirements.txt             # fastapi, uvicorn, sqlalchemy, alembic, pydantic, pillow
│
├── nanobot/                         # Nanobot (в контейнере) — агент, каналы, навыки
│   ├── src/
│   │   ├── main.py                  # запуск nanobot gateway / loop
│   │   ├── agent.py                 # основной цикл: parse → plan → tool calls → respond
│   │   ├── providers/
│   │   │   └── openai_kobold.py     # кастомный провайдер для Koboldcpp (base_url = host.docker.internal:5001/v1)
│   │   ├── skills/
│   │   │   ├── api_bridge.py        # вызовы backend API (httpx)
│   │   │   ├── visualize_plan.py    # запрос схемы → backend → render
│   │   │   ├── status_report.py     # агрегация датчиков, тревоги
│   │   │   └── voice_processor.py   # STT/TTS вызовы через Koboldcpp API (если поддерживает)
│   │   ├── channels/
│   │   │   ├── telegram.py          # aiogram / python-telegram-bot
│   │   │   └── voice_handler.py     # обработка voice → Koboldcpp STT → текст → LLM → TTS → voice reply
│   │   └── config_loader.py         # чтение nanobot_config.json
│   └── requirements.txt             # nanobot-ai (если пакет), aiogram, httpx, pydantic
│
├── shared/                          # Общие схемы между backend и nanobot
│   ├── schemas/
│   │   ├── building.py
│   │   ├── tenant.py
│   │   └── sensor.py
│   └── enums.py
│
├── docker/
│   ├── environments/
│   │   ├── dev-compose.yml          # Гибрид: backend + nanobot в Docker, Koboldcpp на хосте
│   │   └── prod-compose.yml         # для будущего продакшена (если Koboldcpp тоже в контейнер)
│   ├── Dockerfile.backend           # python:3.12-slim + deps
│   ├── Dockerfile.nanobot           # python:3.12 + deps (без CUDA, т.к. LLM на хосте)
│   └── nginx.conf                   # опционально, если нужен reverse-proxy
│
├── tests/
│   ├── backend/
│   ├── nanobot/
│   └── integration/
│
├── docs/
│   ├── architecture.md              # схема: Koboldcpp (host) ↔ nanobot (docker) ↔ backend (docker) ↔ PostgreSQL (external)
│   ├── module-import-diagram.md     # mermaid
│   ├── api-openapi.md
│   ├── db-schema.md
│   └── koboldcpp-integration.md     # как подключить, флаги, порты
│
├── scripts/
│   ├── setup.sh                     # создание venv, pip install
│   ├── run-backend.sh               # uvicorn backend.src.main:app --reload
│   ├── run-nanobot.sh               # python nanobot/src/main.py
│   ├── start-dev.sh                 # docker compose -f dev-compose.yml up --build
│   └── migrate-db.sh                # alembic upgrade head
│
├── models/                          # опционально: симлинк или копии моделей для документации
│   └── README.md                    # где лежат gguf-файлы на хосте
│
├── .gitignore
├── pyproject.toml                   # опционально (poetry/uv)
└── README.md                        # установка, запуск Koboldcpp, docker-compose, подключение Telegram

Краткие комментарии к основным блокам
config/
Хранит всё, что можно менять без перекомпиляции: секреты, LLM параметры, API ключи (если будут гибридные), пути к моделям.
backend/
Единственный компонент, имеющий доступ к PostgreSQL. Содержит всю бизнес-логику, валидацию, авторизацию, аудит. Nanobot — просто «умный клиент» этого API.
nanobot/
Интеллектуальный слой. Обрабатывает естественный язык, голос, планирование, вызовы инструментов. Работает локально (vLLM + STT + TTS). Не имеет прямого доступа к БД — только HTTP к backend.
shared/
Контракт между сервисами. Изменение схемы здесь — сигнал, что нужно обновить и backend, и nanobot.
docker/
Всё для деплоя. Три compose-файла позволяют запускать:
• dev — быстро и просто
• prod — надёжно
• gpu — максимально быстро
tests/
Покрытие критично: backend (данные не потеряются), nanobot (агент не сломается после смены модели), интеграция (голос → текст → план → API → голос).

